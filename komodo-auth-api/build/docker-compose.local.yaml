# Docker Compose for LOCAL environment
# Use this for local development with shared LocalStack
# Start LocalStack first: cd ../../localstack && docker-compose up -d

name: komodo-auth-api-local
services:
  auth-api:
    build:
      context: ..
      dockerfile: build/Dockerfile
      args:
        - ENV=local
    container_name: komodo-auth-api-local
    environment:
      - APP_NAME=komodo-auth-api
      - ENV=local
      - VERSION=1
      - PORT=7001
      - LOG_LEVEL=debug
      - LOG_ENABLE_REMOTE=false
      - USE_MOCKS=true
      - MAX_CONTENT_LENGTH=4096
      - IDEMPOTENCY_TTL_SEC=300
      - RATE_LIMIT_RPS=0
      - RATE_LIMIT_BURST=0
      - BUCKET_TTL_SECOND=300
      - RATE_LIMIT_BUCKET_TTL_SEC=300
      - RATE_LIMIT_FAIL_OPEN=true
      - AWS_REGION=us-east-1
      - AWS_ENDPOINT=http://host.docker.internal:4566
      - AWS_SECRET_PREFIX=komodo-auth-api/local/
      - AWS_BATCH_SECRET_NAME=all-secrets
      - AWS_ELASTICACHE_ENDPOINT=redis:6379
      - AWS_ELASTICACHE_DB=0
      - EVAL_RULES_PATH=/app/config/validation_rules.yml
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:7001/health"]
      interval: 10s
      timeout: 2s
      retries: 5
    image: komodo-auth-api:local
    ports:
      - "7001:7001"
    volumes:
      - ../tests/mocks:/tests/mocks
    networks:
      - komodo-network
networks:
  komodo-network:
    external: true
