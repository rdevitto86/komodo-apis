name: komodo-communications-api

services:
  communications-api:
    image: ${APP_NAME}:${VERSION:-latest}
    build:
      context: ..
      dockerfile: komodo-communications-api/Dockerfile
      args:
        ENV: ${ENV:-local}
    restart: ${RESTART_POLICY:-no}
    deploy:
      resources:
        limits:
          memory: ${MEM_LIMIT:-512M}
    environment:
      APP_NAME: ${APP_NAME}
      ENV: ${ENV}
      PORT: 7081
      VERSION: ${VERSION}
      AWS_REGION: ${AWS_REGION}
      AWS_ENDPOINT: ${AWS_ENDPOINT}
      AWS_SECRET_PREFIX: ${AWS_SECRET_PREFIX}
      AWS_SECRET_BATCH: ${AWS_SECRET_BATCH}
      EVAL_RULES_PATH: /app/config/validation_rules.yml
    ports:
      - "7081:7081"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:7081/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    networks:
      - komodo-network
networks:
  komodo-network:
    external: true
