{"version":3,"file":"hooks.server-DvsLJlfy.js","sources":["../../../.svelte-kit/adapter-node/entries/hooks.server.js"],"sourcesContent":["import { error } from \"@sveltejs/kit\";\nimport { l as logger } from \"../chunks/index.js\";\nconst AUTH_API_URL = process.env.AUTH_API_URL;\nif (!AUTH_API_URL) throw new Error(\"AUTH_API_URL is not defined\");\nasync function validateApiToken(token) {\n  try {\n    const response = await fetch(`${AUTH_API_URL}/auth/validate`, {\n      method: \"POST\",\n      headers: {\n        \"Accept\": \"application/json;v=1\",\n        \"Content-Type\": \"application/json\",\n        \"Authorization\": `Bearer ${token}`\n      }\n    });\n    if (!response.ok) {\n      logger.error(\"Token validation failed\", new Error(`Token validation failed: ${response.status}`));\n      return null;\n    }\n    const data = await response.json();\n    return {\n      id: data.userId,\n      email: data.email,\n      isAdmin: data.role === \"admin\" || data.isAdmin\n    };\n  } catch (err) {\n    logger.error(\"Auth API call failed\", err);\n    return null;\n  }\n}\nconst PROTECTED_ROUTES = [\n  \"/orders\",\n  \"/marketing/*\",\n  \"/services/scheduling\"\n].map((route) => new RegExp(`/api(/v\\\\d+)?${route.replace(/\\*/g, \"(/.*)?\")}(/|$)`));\nconst ADMIN_ROUTES = [\n  \"/admin/manage/content/*\"\n].map((route) => new RegExp(`/api(/v\\\\d+)?${route.replace(/\\*/g, \"(/.*)?\")}(/|$)`));\nconst handle = async ({ event, resolve }) => {\n  try {\n    const start = Date.now();\n    const path = event.url.pathname;\n    const token = event.request.headers.get(\"Authorization\")?.replace(\"Bearer \", \"\");\n    if (token) {\n      event.locals.user = await validateApiToken(token);\n    }\n    if (isValidRoute(PROTECTED_ROUTES, path) && !event.locals.user) {\n      throw error(401, \"Unauthorized - Valid token required\");\n    }\n    if (isValidRoute(ADMIN_ROUTES, path) && !event.locals.user?.isAdmin) {\n      throw error(403, \"Forbidden - Admin access required\");\n    }\n    const response = await resolve(event);\n    logger.info(\"Request completed\", {\n      method: event.request.method,\n      path,\n      status: response.status,\n      duration: Date.now() - start,\n      userId: event.locals.user?.id\n    });\n    return response;\n  } catch (err) {\n    logger.error(\"Request failed\", err);\n    throw err;\n  }\n};\nconst isValidRoute = (routes, path) => routes.some((pattern) => pattern.test(path));\nexport {\n  handle\n};\n"],"names":[],"mappings":"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"}