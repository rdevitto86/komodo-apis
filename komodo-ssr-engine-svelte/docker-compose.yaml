name: komodo-ssr-engine-svelte

services:
  ssr-api:
    image: ${APP_NAME}:${VERSION:-latest}
    build:
      context: ..
      dockerfile: komodo-ssr-engine-svelte/Dockerfile
    restart: ${RESTART_POLICY:-no}
    deploy:
      resources:
        limits:
          memory: ${MEM_LIMIT:-512M}
    environment:
      PORT: 7001
      NODE_ENV: ${NODE_ENV:-development}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_ENDPOINT: ${AWS_ENDPOINT}
      S3_CONTENT_BUCKET: ${S3_CONTENT_BUCKET}
      CLOUDFRONT_DISTRIBUTION_ID: ${CLOUDFRONT_DISTRIBUTION_ID}
    ports:
      - "7001:7001"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:7001/api/v1/health').then(r=>{if(!r.ok)process.exit(1)}).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    networks:
      - komodo-network
networks:
  komodo-network:
    external: true